name: DevOps Todo App CI/CD Pipeline

# This workflow triggers on every push to the main branch
on:
  push:
    branches: [ "main" ]

jobs:
  # Job 1: Build and Push Docker Image
  build-and-push:
    name: Build and Push to Docker Hub
    # Each job runs on a fresh, clean virtual machine provided by GitHub
    runs-on: ubuntu-latest
    steps:
      # Step 1.1: Checks out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout Code
        uses: actions/checkout@v3

      # Step 1.2: Logs into Docker Hub using the secrets you created in GitHub Settings
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Step 1.3: Builds the Docker image from your Dockerfile and pushes it to your Docker Hub account
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          # The path to the Dockerfile and source code
          context: .
          # This flag tells the action to push after a successful build
          push: true
          # This creates the tag for the image, e.g., "rnkbansal/devops-todo-app:latest"
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/devops-todo-app:latest

  # Job 2: Deploy to Kubernetes (Simulation)
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    # This 'needs' keyword is critical. It ensures that the deploy job will ONLY run
    # if the 'build-and-push' job has finished successfully.
    needs: build-and-push
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # This is a placeholder for a real deployment. To deploy to a real cloud
      # cluster (like AWS EKS or Google GKE), you would configure kubectl here
      # with cloud credentials, which would also be stored as GitHub Secrets.
      - name: "Simulate Deployment to Cluster"
        run: |
          echo "ðŸš€ Deploying new image version to Kubernetes..."
          echo "Image to be deployed: ${{ secrets.DOCKERHUB_USERNAME }}/devops-todo-app:latest"
          echo "In a real setup, 'kubectl apply -f k8s/' would run here."
          echo "ðŸŽ‰ Deployment simulation complete!"